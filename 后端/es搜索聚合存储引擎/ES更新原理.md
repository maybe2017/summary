## Elasticsearch 更新原理解析
1. Elasticsearch是一个开源的 `实时分布式搜索和分析引擎`，它使用 `倒排索引的数据结构` 来提供快速的 `全文搜索`。
2. 在使用Elasticsearch的过程中，经常会遇到需要对索引进行更新的情况。本文将详细解释 Elasticsearch的更新原理，包括更新的流程、数据存储方式、更新的实现机制等内容。
### 一、更新流程
#### 更新的基本流程
1. 客户端向Elasticsearch发送更新请求。 
2. Elasticsearch将更新请求解析为对应的索引和文档。
3. Elasticsearch检查文档是否存在，如果存在则继续下一步，如果不存在则创建新文档。 
4. Elasticsearch加载文档的源数据，并根据更新请求进行相应的修改。 
5. Elasticsearch将修改后的文档保存到倒排索引中。 
6. Elasticsearch返回更新结果给客户端。

#### 数据存储方式、更新实现机制、详细解释   [更新的核心工作是修改文档并将其保存到倒排索引中]
1. Elasticsearch使用的数据存储方式是倒排索引。倒排索引将每个词都映射到包含该词的文档列表，这种方式使得搜索过程更加高效。
2. 在更新过程中，Elasticsearch会加载文档的源数据，并在内存中创建一个副本。这个副本包含了文档的 `所有字段和对应的值`。在对文档进行更新时，Elasticsearch会修改这个副本中的字段值，并重新保存到倒排索引中。
3. 由于倒排索引是不可变的(即一旦建立就不能修改)，因此Elasticsearch在更新文档时采用了一种称为 `段合并` 的技术。即将修改后的文档添加到一个新的段中，并在后续的查询中同时搜索新旧两个段，以确保查询的一致性。
#### 更新实现机制
1. ES的更新实现机制是基于 `乐观并发控制`(Optimistic Concurrency Control)的。这种机制非常适合 `并发更新场景`，并可以提高系统的性能和吞吐量。
2. 在更新过程中，ES会检查文档的版本号。每个文档都有一个唯一的版本号，用于标识文档的修改历史。当一个更新请求到达ES时，它会将文档的版本号与请求中携带的版本号进行比较，如果不一致则返回一个版本冲突的错误。
3. 如果版本号一致，则ES会进行更新操作。在更新过程中，ES会将文档的源数据加载到内存中，并进行字段的修改。然后，ES会为修改后的文档生成一个新的版本号，并将其保存到倒排索引中。
4. 通过乐观并发控制机制，ES可以在并发更新的情况下保证操作的一致性和可靠性。同时由于 `不需要加锁` 等额外开销，这种机制也能够提高系统的性能和吞吐量。
#### 更新的处理方式
https://wenku.baidu.com/view/09a27033b007e87101f69e3143323968011cf4ab.html?_wkts_=1704954423000&bdQuery=ES更新原理 1/22024/1/11 14:47 es更新原理 - 百度文库
在Elasticsearch中，更新操作可以分为两种情况:更新和替换。
更新(Update):更新操作是对文档的字段进行修改，而不是替换整个文档。当更新一个文档时， Elasticsearch会加载原始文档的源数据，并根据更新请求对字段进行修改。修改后的文档会被保存到 倒排索引中，并生成一个新的版本号。
替换(Replace):替换操作是用新的文档替换原始的文档。当替换一个文档时，Elasticsearch会直接 将新文档保存到倒排索引中，并生成一个新的版本号。这种操作会比更新操作更加耗时，因为需要 将整个文档写入磁盘。
Elasticsearch根据文档ID来判断是执行更新操作还是替换操作。如果请求中没有指定文档ID，则会执 行替换操作;如果指定了文档ID，则会执行更新操作。
并发更新的冲突处理
在高并发的场景下，可能会出现多个并发更新操作冲突的情况。Elasticsearch会通过版本号来解决这 个问题。
当多个并发更新操作到达Elasticsearch时，它们会依次执行，并依次检查版本号。如果版本号一致， 则允许更新操作执行;如果版本号不一致，则会返回一个版本冲突的错误。