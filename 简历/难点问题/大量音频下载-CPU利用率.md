

### 背景
需要在固定时间内，对上w音频完成质检；那么如何缩短质检流程时间，成了突破口

### 重点阶段 - 哪个阶段会成为最终的瓶颈？
1. 音频从客户端下载到本地，如果减少下载的时间？
2. 音频文件的转码，从mp3、wav、v3等格式，需要转为pcm文件，如何减少转码流程时间？
3. 音频转写为文本，受限于引擎路数，引擎转写速度是否成为最后的系统瓶颈？
4. 文本分析结果的写入ES，如何提高写入速度？



### 音频下载阶段，如何提高下载的吞吐量？

#### 问题
1. 线程池的使用，普通JVM线程不能无限制创建，new一个Thread对象，对应一个栈内存为1M的操作系统线程，那么个数受限于堆外内存。
2. 传统线程下载音频时，为什么会有阻塞的问题？
    ```
    // 同步阻塞IO操作
    1. 通过 InputStream.read() 或 HttpURLConnection.getInputStream() 时，线程会被操作系统内核挂起，直到数据从网络传输到内核缓冲区
    2. 在此期间，传统线程无法执行任何其他任务，处于 BLOCKED 状态（可通过 jstack 命令观察）
    3. 内核线程的上下文切换成本高（涉及 CPU 寄存器、栈数据等切换）
    4. 当大量线程同时阻塞在 IO 操作时，内核需要频繁调度线程，导致 CPU 资源浪费

    // 线程资源有限性
    1. 内核线程数量受限于 CPU 核心数（如 8 核 CPU 最多同时运行 8 个线程）
    2. 大量阻塞线程的上下文切换会导致 CPU 使用率飙升，但实际有效工作时间占比低【】
    ```

#### 解决方案
1. 因为当前项目依然采用的是Jdk8，而非Jdk21+，所以无法使用虚拟线程。
2. 引用Fiber协程库Quasar，提供比线程更轻量级的执行单元，适合 IO 密集型任务。【类协程方案】
    ```
    需要使用 Java Agent 增强字节码：java -javaagent:quasar-core-0.8.2.jar

    ```
3. Reactor（Spring 官方响应式框架）, Reactor 是 Spring 生态的响应式编程基础，提供Mono和Flux等异步流抽象。
4. RxJava（响应式编程）通过异步流处理实现高并发，适合 IO 密集型场景，避免阻塞线程。    


#### CPU 使用率的 “虚高” 现象 【阻塞线程的 “无效忙碌” 】
启动一个包含 1000 个阻塞线程的程序，观察：
1. CPU 使用率：内核态（%sys）占比高，用户态（%user）占比低
2. 上下文切换次数：每秒可达数万次，远超正常水平（正常程序通常每秒数百次）
3. 内核被迫频繁调度大量 “假死” 的线程—— 这些线程大部分时间在等待 IO，但每次唤醒都需要消耗 CPU 资源进行状态切换，却无法贡献实际的业务处理时间


#### 知识点
大量阻塞线程的上下文切换会导致 CPU 使用率飙升，但实际有效工作时间占比低，怎么理解这句话？阻塞的线程为什么还会进行上下文切换呢？

1. 线程会向操作系统内核发起read系统调用，内核发现数据未准备好（如网络数据包未到达），会将线程标记为 阻塞状态，并从 运行队列 中移除。
2. 关键误区：阻塞线程并非完全 “停止”，而是内核会定期检查其阻塞条件是否解除（如通过超时机制或 IO 完成通知）。